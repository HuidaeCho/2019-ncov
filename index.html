<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>2019-nCoV Cases</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.1.1/css/ol.css">
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.1.1/build/ol.js"></script>

<link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@3.5.0/src/ol-layerswitcher.css" />
<script src="https://unpkg.com/ol-layerswitcher@3.5.0"></script>

<link rel="stylesheet" href="https://cdn.rawgit.com/Viglino/ol-ext/master/dist/ol-ext.min.css" />
<script type="text/javascript" src="https://cdn.rawgit.com/Viglino/ol-ext/master/dist/ol-ext.min.js"></script>

<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>

<style type="text/css">
html {
	width: 100%;
	height: 100%;
}
body {
	width: 99%;
	height: 99%;
	font-family: sans-serif;
	overflow: hidden;
}
#header {
	float: left;
}
h1 {
	font-size: 150%;
}
#map {
	display: inline-block;
}
#info {
	display: inline-block;
	vertical-align: top;
	width: 30%;
	max-width: 300px;
	font-size: 95%;
}
.popup-header {
	text-align: center;
	font-weight: bold;
}
.stats {
	width: 100%;
}
.numeric {
	text-align: right;
}
.confirmed {
	background-color: #00000055;
}
.recovered {
	background-color: #00ff0055;
}
.deaths {
	background-color: #ff000055;
}
</style>
</head>
<body>
<div id="header">
<h1>2019-nCoV Cases</h1>
<div>
This web map was motivated by <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">the 2019-nCoV global cases website by Johns Hopkins SCCE</a>. I wanted to develop a similar, but open source version of the website using their <a href="https://docs.google.com/spreadsheets/d/1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo/export?format=ods&id=1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo">spreadsheet data</a>, <a href="https://services1.arcgis.com/0MSEUqKaxRlEPj5g/ArcGIS/rest/services/ncov_cases/FeatureServer/1/query?where=1%3D1&outFields=*&f=json">REST API</a>, and <a href="https://openlayers.org">OpenLayers</a>. Data is fetched hourly and all times are in EST. Click circles for attributes and visit <a href="https://github.com/HuidaeCho/2019-ncov">the GitHub repository</a> for implementation details. Since February 2, 2020 by <a href="https://idea.isnew.info">Huidae Cho</a>.
<div>
<span class="confirmed">Confirmed</span>
<span class="recovered">Recovered</span>
<span class="deaths">Deaths</span>
</div>
</div>
<div id="map"></div>
<div id="info">
<div id="summary"></div>
<div id="plot"></div>
</div>
<script>
var bodyEl = document.body;
var headerEl = document.getElementById('header');
var mapEl = document.getElementById('map');
var infoEl = document.getElementById('info');
var summaryEl = document.getElementById('summary');
mapEl.style.height = (bodyEl.offsetHeight - headerEl.offsetHeight) + 'px';
mapEl.style.width = (bodyEl.offsetWidth - infoEl.offsetWidth - 11) + 'px';

var getColor = function(category){
	return window.getComputedStyle(document.getElementsByClassName(category)[0]).backgroundColor
}
var createStyle = function(feature, resolution, category){
	var timeSeries = feature.get(category);
	lastIndex = timeSeries.length - 1;
	time = timeSeries[lastIndex].time;
	count = timeSeries[lastIndex].count;
	var radius = Math.log10(count+1)*10;
	var style = new ol.style.Style({
		image: new ol.style.Circle({
			radius: radius,
			fill: new ol.style.Fill({
				color: getColor(category)
			})
		})
	});
	return style;
}

var popup = new ol.Overlay.Popup();

var map = new ol.Map({
	target: 'map',
	controls: ol.control.defaults().extend([new ol.control.ScaleLine({units:'us'})]),
	layers: [
		new ol.layer.Group({
			title: 'Base maps',
			layers: [
				new ol.layer.Group({
					title: 'Water color with labels',
					type: 'base',
					combine: true,
					layers: [
						new ol.layer.Tile({
							source: new ol.source.Stamen({
								layer: 'watercolor'
							})
						}),
						new ol.layer.Tile({
							source: new ol.source.Stamen({
								layer: 'terrain-labels'
							})
						})
					]
				}),
				new ol.layer.Tile({
					title: 'Water color',
					type: 'base',
					source: new ol.source.Stamen({
						layer: 'watercolor'
					})
				}),
				new ol.layer.Tile({
					title: 'Bing aerial',
					type: 'base',
					source: new ol.source.BingMaps({
						// XXX: Add your Bing Maps key here and secure it from the Bing Maps Dev Center at https://www.bingmapsportal.com
						key: 'AhuHr9JixtsyKu9uSOQ8W0lIr7_gC2KiFxOlmshvRDb_BSWDkhnGX7oeS5zJzHo0',
						imagerySet: 'AerialWithLabelsOnDemand',
					})
				}),
				new ol.layer.Tile({
					title: 'Open Street',
					type: 'base',
					source: new ol.source.OSM()
				})
			]
		}),
		new ol.layer.Group({
			title: 'Overlays',
			layers: [
				new ol.layer.Vector({
					title: '2019-nCoV confirmed cases',
					source: new ol.source.Vector({
						format: new ol.format.GeoJSON(),
						url: 'geodata.json',
						attributions: '&copy; Data source: <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">2019-nCoV Global Cases by Johns Hopkins CSSE</a>'
					}),
					style: function(feature, resolution){
						return createStyle(feature, resolution, 'confirmed');
					}
				}),
				new ol.layer.Vector({
					title: '2019-nCoV recovered cases',
					source: new ol.source.Vector({
						format: new ol.format.GeoJSON(),
						url: 'geodata.json',
						attributions: '&copy; Data source: <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">2019-nCoV Global Cases by Johns Hopkins CSSE</a>'
					}),
					style: function(feature, resolution){
						return createStyle(feature, resolution, 'recovered');
					}
				}),
				new ol.layer.Vector({
					title: '2019-nCoV death cases',
					source: new ol.source.Vector({
						format: new ol.format.GeoJSON(),
						url: 'geodata.json',
						attributions: '&copy; Data source: <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">2019-nCoV Global Cases by Johns Hopkins CSSE</a>'
					}),
					style: function(feature, resolution){
						return createStyle(feature, resolution, 'deaths');
					}
				}),
			]
		})
	],
	view: new ol.View({
		center: ol.proj.fromLonLat([37.41, 8.82]),
		zoom: 1,
	}),
	overlays: [popup],
});
var layerSwitcher = new ol.control.LayerSwitcher();
map.addControl(layerSwitcher);

map.on('singleclick', function(evt){
	var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer){
		return feature;
	});
	if(feature){
		var country = feature.get('country');
		var province = feature.get('province');
		var firstConfirmedDate = new Date(feature.get('first_confirmed_date')).toLocaleString('en-US');
		var confirmed = feature.get('confirmed');
		var recovered = feature.get('recovered')
		var deaths = feature.get('deaths');

		var lastIndex = confirmed.length - 1;
		var lastUpdated = new Date(confirmed[lastIndex].time).toLocaleString('en-US');
		var lastConfirmed = confirmed[lastIndex].count;
		var lastRecovered = recovered[lastIndex].count;
		var lastDeaths = deaths[lastIndex].count;

		if(lastConfirmed) lastConfirmed = lastConfirmed.toLocaleString('en-US');
		if(lastRecovered) lastRecovered = lastRecovered.toLocaleString('en-US');
		if(lastDeaths) lastDeaths = lastDeaths.toLocaleString('en-US');

		var content =
			'<div class="popup-header">' + (province == '' ? '' : province + ', ') + country + '</div>' +
			'<table class="stats">' +
			'<tr><td>First confirmed:</td><td>' + firstConfirmedDate + '</td></tr>' +
			'<tr><td>Last updated:</td><td>' + lastUpdated + '</td></tr>' +
			(lastConfirmed ? '<tr class="confirmed"><td>Confirmed:</td><td class="numeric">' + lastConfirmed + '</td></tr>' : '') +
			(lastRecovered ? '<tr class="recovered"><td>Recovered:</td><td class="numeric">' + lastRecovered + '</td></tr>' : '') +
			(lastDeaths ? '<tr class="deaths"><td>Deaths:</td><td class="numeric">' + lastDeaths + '</td></tr>' : '') +
			'</table>' +
			'<div id="popup-plot"></div>';
		popup.show(evt.coordinate, content);

		var time = [];
		var confirmedCounts = [];
		var recoveredCounts = [];
		var deathsCounts = [];

		for(var i = 0; i <= lastIndex; i++){
			var c = confirmed[i].count;
			var r = recovered[i].count;
			var d = deaths[i].count;
			if(c || r || d){
				time.push(confirmed[i].time);
				confirmedCounts.push(c);
				recoveredCounts.push(r);
				deathsCounts.push(d);
			}
		}

		var trends = [];
		trends.push({
			name: 'Confirmed',
			x: time,
			y: confirmedCounts,
			marker: {
				color: getColor('confirmed')
			}
		});
		trends.push({
			name: 'Recovered',
			x: time,
			y: recoveredCounts,
			marker: {
				color: getColor('recovered')
			}
		});
		trends.push({
			name: 'Deaths',
			x: time,
			y: deathsCounts,
			marker: {
				color: getColor('deaths')
			}
		});
		var layout = {
			width: 240,
			height: 100,
			margin: {
				l: 25,
				r: 0,
				b: 30,
				t: 5
			},
			showlegend: false
		};
		Plotly.newPlot('popup-plot', trends, layout);
	}else{
		popup.hide();
	}
});

var xhr = new XMLHttpRequest();
xhr.open('GET', 'geodata.json', true);
xhr.responseType = 'json';
xhr.onload = function(){
	var status = xhr.status;
	if(status == 200){
		var data = xhr.response;
		var features = data.features;
		var time = [];
		var confirmedCounts = [];
		var recoveredCounts = [];
		var deathsCounts = [];
		var lastUpdated = 0;
		for(var i = 0; i < features.length; i++){
			var feature = features[i];
			var confirmed = feature.properties.confirmed;
			var recovered = feature.properties.recovered;
			var deaths = feature.properties.deaths;
			var updated = Date.parse(confirmed[confirmed.length-1].time);
			if(updated > lastUpdated)
				lastUpdated = updated;
			for(var j = 0; j < confirmed.length; j++){
				var c = Number(confirmed[j].count);
				var r = Number(recovered[j].count);
				var d = Number(deaths[j].count);
				if(j + 1 > time.length){
					time.push(confirmed[j].time);
					confirmedCounts.push(c);
					recoveredCounts.push(r);
					deathsCounts.push(d);
				}else{
					confirmedCounts[j] += c;
					recoveredCounts[j] += r;
					deathsCounts[j] += d;
				}
				if(j == confirmed.length - 1 && confirmedCounts.length > confirmed.length){
					var k = confirmedCounts.length - 1;
					confirmedCounts[k] += c;
					recoveredCounts[k] += r;
					deathsCounts[k] += d;
				}
			}
			console.log(feature.properties.country, feature.properties.province, confirmed[confirmed.length-1].count);
		}
		lastUpdated = new Date(lastUpdated).toLocaleString('en-US');
		var lastIndex = time.length - 1;
		var totalConfirmed = confirmedCounts[lastIndex].toLocaleString('en-US');
		var totalRecovered = recoveredCounts[lastIndex].toLocaleString('en-US');
		var totalDeaths = deathsCounts[lastIndex].toLocaleString('en-US');
		summaryEl.innerHTML =
			'<table class="stats">' +
			'<tr><td>Last Updated:</td><td>' + lastUpdated + '</td></tr>' +
			'<tr class="confirmed"><td>Total Confirmed:</td><td class="numeric">' + totalConfirmed + '</td></tr>' +
			'<tr class="recovered"><td>Total Recovered:</td><td class="numeric">' + totalRecovered + '</td></tr>' +
			'<tr class="deaths"><td>Total Deaths:</td><td class="numeric">' + totalDeaths + '</td></tr>' +
			'</table>';
		var trends = [];
		trends.push({
			name: 'Confirmed',
			x: time,
			y: confirmedCounts,
			marker: {
				color: getColor('confirmed')
			}
		});
		trends.push({
			name: 'Recovered',
			x: time,
			y: recoveredCounts,
			marker: {
				color: getColor('recovered')
			}
		});
		trends.push({
			name: 'Deaths',
			x: time,
			y: deathsCounts,
			marker: {
				color: getColor('deaths')
			}
		});
		var layout = {
			margin: {
				l: 25,
				r: 0,
				b: 30,
				t: 20
			},
			showlegend: false
		};
		Plotly.newPlot('plot', trends, layout);
	}else{
		console.log(status);
	}
};
xhr.send();
</script>
</body>
</html>
