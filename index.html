<!doctype html>
<html>
<head>
<title>2019-nCoV Cases</title>
<meta charset="utf-8" />
<meta http-equiv="refresh" content="3600" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.1.1/css/ol.css">
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.1.1/build/ol.js"></script>
<link rel="stylesheet" href="https://cdn.rawgit.com/Viglino/ol-ext/master/dist/ol-ext.min.css" />
<script type="text/javascript" src="https://cdn.rawgit.com/Viglino/ol-ext/master/dist/ol-ext.min.js"></script>
<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
<style type="text/css">
html {
	width: 100%;
	height: 100%;
}
body {
	width: 99%;
	height: 99%;
	overflow: hidden;
	font-family: sans-serif;
	font-size: 149%;
}
h1 {
	font-size: 2em;
	margin-top: 0;
	margin-bottom: 5px;
}
#header {
	line-height: 1.3;
}
.desktop {
	display: none;
}
.mobile {
	display: block;
}
#map {
	display: inline-block;
}
#info {
	display: inline-block;
	vertical-align: top;
	width: 30%;
	max-width: 300px;
	font-size: 0.95em;
}
.popup-header {
	text-align: center;
	font-weight: bold;
	margin-bottom: 5px;
}
.stats {
	border-collapse: collapse;
}
#summary-header {
	font-size: 1.5em;
	font-weight: bold;
	text-align: center;
	margin-bottom: 10px;
}
.global-stats {
	width: 100%;
	font-size: 1.3em;
	font-weight: bold;
	border-collapse: collapse;
}
.center {
	text-align: center;
}
.right {
	text-align: right;
}
.confirmed {
	background-color: #00000055;
}
.recovered {
	background-color: #00ff0055;
}
.deaths {
	background-color: #ff000055;
}
#plots {
	margin-bottom: 10px;
}
#stats-by-province {
	overflow: auto;
}
.stats-by-province {
	border-top: 1px solid black;
	padding: 5px;
	font-size: 0.95em;
}
.stats-by-province .province {
	font-weight: bold;
	margin-bottom: 5px;
}
.stats-by-province .confirmed, .stats-by-province .recovered, .stats-by-province .deaths {
	margin-left: 10px;
	background-color: inherit;
}
.stats-by-province .confirmed {
	color: black;
}
.stats-by-province .recovered {
	color: green;
}
.stats-by-province .deaths {
	color: red;
}
@media screen and (min-width: 981px) {
	body {
		font-size: 100%;
	}
	#header {
		line-height: 1.5;
	}
	.desktop {
		display: block;
	}
	.mobile {
		display: none;
	}
}
</style>
</head>
<body>
<div id="header">
<h1>2019-nCoV Cases</h1>
<div>
<div class="desktop">
This web map was motivated by <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">the 2019-nCoV global cases website</a> by <a href="https://systems.jhu.edu">Johns Hopkins CSSE</a>. I wanted to develop a similar, but open source version of their website using their <a href="https://docs.google.com/spreadsheets/d/1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo/export?format=ods&id=1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo">time series</a>, <a href="https://services1.arcgis.com/0MSEUqKaxRlEPj5g/ArcGIS/rest/services/ncov_cases/FeatureServer/1/query?where=1%3D1&outFields=*&f=json">REST API</a>, and <a href="https://openlayers.org">OpenLayers</a>. Data is fetched hourly and all times are in EST. Click circles for attributes and visit <a href="https://github.com/HuidaeCho/2019-ncov">the GitHub repository</a> for implementation details. I am not responsible for any damages caused by using this website. Since February 2, 2020 by <a href="https://idea.isnew.info">Huidae Cho</a>.
</div>
<div class="mobile">
<div>Times in EST. <a href="https://github.com/HuidaeCho/2019-ncov">GitHub repository</a>. Since February 2, 2020 by <a href="https://idea.isnew.info">Huidae Cho</a>.</div>
<div>Data sources: <a href="https://systems.jhu.edu">JHU CSSE</a> <a href="https://docs.google.com/spreadsheets/d/1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo/export?format=ods&id=1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo">time series</a>, <a href="https://services1.arcgis.com/0MSEUqKaxRlEPj5g/ArcGIS/rest/services/ncov_cases/FeatureServer/1/query?where=1%3D1&outFields=*&f=json">REST API</a>.</div>
</div>
<div>
<span class="confirmed">Confirmed</span>
<span class="recovered">Recovered</span>
<span class="deaths">Deaths</span>
</div>
</div>
</div>
<div id="map"></div>
<div id="info">
<div id="summary">
<div id="summary-header">Global Total</div>
<div class="center">Last Updated: <span id="last-updated"></span></div>
<table class="global-stats">
<tr class="confirmed"><td>Confirmed:</td><td id="total-confirmed" class="right"></td></tr>
<tr class="recovered"><td>Recovered:</td><td id="total-recovered" class="right"></td></tr>
<tr class="deaths"><td>Deaths:</td><td id="total-deaths" class="right"></td></tr>
<tr class="fatility-rate"><td>Fatality Rate:</td><td id="fatality-rate" class="right"></td></tr>
</table>
</div>
<div id="plots">
<div id="count-plot"></div>
<div id="fatality-plot"></div>
</div>
<div id="stats-by-province"></div>
</div>
<script>
var bodyEl = document.body;
var headerEl = document.getElementById('header');
var mapEl = document.getElementById('map');
var infoEl = document.getElementById('info');
var lastUpdatedEl = document.getElementById('last-updated');
var totalConfirmedEl = document.getElementById('total-confirmed');
var totalRecoveredEl = document.getElementById('total-recovered');
var totalDeathsEl = document.getElementById('total-deaths');
var fatalityRateEl = document.getElementById('fatality-rate');
var summaryEl = document.getElementById('summary');
var plotsEl = document.getElementById('plots');
var statsByProvinceEl = document.getElementById('stats-by-province');
mapEl.style.height = (bodyEl.offsetHeight - headerEl.offsetHeight) + 'px';
mapEl.style.width = (bodyEl.offsetWidth - infoEl.offsetWidth - 11) + 'px';

var getColor = function(category, opaque=false){
	var color = window.getComputedStyle(document.getElementsByClassName(category)[0]).backgroundColor;
	if(opaque)
		color = color.replace(/,[^,]*\)/, ', 1)');
	return color;
}
var createStyle = function(feature, resolution, category){
	var timeSeries = feature.get(category);
	lastIndex = timeSeries.length - 1;
	time = timeSeries[lastIndex].time;
	count = timeSeries[lastIndex].count;
	var radius = Math.log10(count+1)*10;
	var style = new ol.style.Style({
		image: new ol.style.Circle({
			radius: radius,
			fill: new ol.style.Fill({
				color: getColor(category)
			})
		})
	});
	return style;
}

var popup = new ol.Overlay.Popup();

var map = new ol.Map({
	target: 'map',
	controls: ol.control.defaults().extend([new ol.control.ScaleLine({units:'us'})]),
	layers: [
		new ol.layer.Group({
			title: 'Base maps',
			openInLayerSwitcher: true,
			layers: [
				new ol.layer.Group({
					title: 'Water color with labels',
					baseLayer: true,
					combine: true,
					layers: [
						new ol.layer.Tile({
							source: new ol.source.Stamen({
								layer: 'watercolor'
							})
						}),
						new ol.layer.Tile({
							source: new ol.source.Stamen({
								layer: 'terrain-labels'
							})
						})
					],
					visible: false
				}),
				new ol.layer.Tile({
					title: 'Water color',
					baseLayer: true,
					source: new ol.source.Stamen({
						layer: 'watercolor'
					}),
					visible: false
				}),
				new ol.layer.Tile({
					title: 'Bing aerial',
					baseLayer: true,
					source: new ol.source.BingMaps({
						// XXX: Add your Bing Maps key here and secure it from the Bing Maps Dev Center at https://www.bingmapsportal.com
						key: 'AhuHr9JixtsyKu9uSOQ8W0lIr7_gC2KiFxOlmshvRDb_BSWDkhnGX7oeS5zJzHo0',
						imagerySet: 'AerialWithLabelsOnDemand',
					}),
					visible: false
				}),
				new ol.layer.Tile({
					title: 'Open Street',
					baseLayer: true,
					source: new ol.source.OSM()
				})
			]
		}),
		new ol.layer.Group({
			title: '2019-nCoV cases',
			openInLayerSwitcher: true,
			layers: [
				new ol.layer.Vector({
					title: 'Confirmed',
					source: new ol.source.Vector({
						format: new ol.format.GeoJSON(),
						url: 'geodata.json',
						attributions: '&copy; Data source: <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">2019-nCoV Global Cases by Johns Hopkins CSSE</a>'
					}),
					style: function(feature, resolution){
						return createStyle(feature, resolution, 'confirmed');
					}
				}),
				new ol.layer.Vector({
					title: 'Recovered',
					source: new ol.source.Vector({
						format: new ol.format.GeoJSON(),
						url: 'geodata.json',
						attributions: '&copy; Data source: <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">2019-nCoV Global Cases by Johns Hopkins CSSE</a>'
					}),
					style: function(feature, resolution){
						return createStyle(feature, resolution, 'recovered');
					}
				}),
				new ol.layer.Vector({
					title: 'Deaths',
					source: new ol.source.Vector({
						format: new ol.format.GeoJSON(),
						url: 'geodata.json',
						attributions: '&copy; Data source: <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">2019-nCoV Global Cases by Johns Hopkins CSSE</a>'
					}),
					style: function(feature, resolution){
						return createStyle(feature, resolution, 'deaths');
					}
				}),
			]
		})
	],
	view: new ol.View({
		center: ol.proj.fromLonLat([37.41, 8.82]),
		zoom: 1,
	}),
	overlays: [popup],
});
var layerSwitcher = new ol.control.LayerSwitcher();
map.addControl(layerSwitcher);

map.on('singleclick', function(evt){
	var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer){
		return feature;
	});
	if(feature)
		showStats(feature, evt.coordinate);
	else
		popup.hide();
});

var showStats = function(feature, coor){
	var country = feature.get('country');
	var province = feature.get('province');
	var firstConfirmedDate = feature.get('first_confirmed_date') ? new Date(feature.get('first_confirmed_date').replace(/-/g, '/')).toLocaleDateString('en-US') : '';
	var confirmed = feature.get('confirmed');
	var recovered = feature.get('recovered')
	var deaths = feature.get('deaths');

	var lastIndex = confirmed.length - 1;
	var lastUpdated = new Date(confirmed[lastIndex].time.replace(/-/g, '/')).toLocaleString('en-US');
	var lastConfirmed = confirmed[lastIndex].count;
	var lastRecovered = recovered[lastIndex].count;
	var lastDeaths = deaths[lastIndex].count;

	if(lastConfirmed) lastConfirmed = lastConfirmed.toLocaleString('en-US');
	if(lastRecovered) lastRecovered = lastRecovered.toLocaleString('en-US');
	if(lastDeaths) lastDeaths = lastDeaths.toLocaleString('en-US');

	var content =
		'<div class="popup-header">' + (province == '' ? '' : province + ', ') + country + '</div>' +
		'<table class="stats">' +
		(firstConfirmedDate ? '<tr><td>First Confirmed:</td><td>' + firstConfirmedDate + '</td></tr>' : '') +
		'<tr><td>Last Updated:</td><td>' + lastUpdated + '</td></tr>' +
		(lastConfirmed ? '<tr class="confirmed"><td>Confirmed:</td><td class="right">' + lastConfirmed + '</td></tr>' : '') +
		(lastRecovered ? '<tr class="recovered"><td>Recovered:</td><td class="right">' + lastRecovered + '</td></tr>' : '') +
		(lastDeaths ? '<tr class="deaths"><td>Deaths:</td><td class="right">' + lastDeaths + '</td></tr>' : '') +
		'</table>' +
		'<div id="popup-plot"></div>';

	popup.show(coor, content);

	var time = [];
	var confirmedCounts = [];
	var recoveredCounts = [];
	var deathsCounts = [];

	for(var i = 0; i <= lastIndex; i++){
		var c = confirmed[i].count;
		var r = recovered[i].count;
		var d = deaths[i].count;
		if(c || r || d){
			time.push(confirmed[i].time);
			confirmedCounts.push(c);
			recoveredCounts.push(r);
			deathsCounts.push(d);
		}
	}

	var trends = [];
	trends.push({
		name: 'Confirmed',
		x: time,
		y: confirmedCounts,
		marker: {
			color: getColor('confirmed')
		}
	});
	trends.push({
		name: 'Recovered',
		x: time,
		y: recoveredCounts,
		marker: {
			color: getColor('recovered')
		}
	});
	trends.push({
		name: 'Deaths',
		x: time,
		y: deathsCounts,
		marker: {
			color: getColor('deaths')
		}
	});
	var layout = {
		width: 240,
		height: 100,
		margin: {
			l: 25,
			r: 0,
			b: 30,
			t: 5
		},
		showlegend: false
	};
	Plotly.newPlot('popup-plot', trends, layout);
};

var layerSource = map.getLayers().item(1).getLayers().item(0).getSource();

var showStatsById = function(id){
	var feature = layerSource.getFeatureById(id);
	var coor = feature.getGeometry().getCoordinates();
	map.getView().setCenter(coor);
	showStats(feature, coor);
};

var xhr = new XMLHttpRequest();
xhr.open('GET', 'geodata.json', true);
xhr.responseType = 'json';
xhr.onload = function(){
	var status = xhr.status;
	if(status == 200){
		var data = xhr.response;
		var features = data.features;
		var time = [];
		var confirmedCounts = [];
		var recoveredCounts = [];
		var deathsCounts = [];
		var lastUpdated = 0;
		var statsByProvince = '';
		var maxConfirmed = 0;
		var maxCoor;
		for(var i = 0; i < features.length; i++){
			var feature = features[i];
			var id = feature.id;
			var country = feature.properties.country;
			var province = feature.properties.province;
			var latitude = feature.geometry.coordinates[1];
			var longitude = feature.geometry.coordinates[0];
			var confirmed = feature.properties.confirmed;
			var recovered = feature.properties.recovered;
			var deaths = feature.properties.deaths;
			var updated = Date.parse(confirmed[confirmed.length-1].time.replace(/-/g, '/'));
			if(updated > lastUpdated)
				lastUpdated = updated;
			for(var j = 0; j < confirmed.length; j++){
				var c = Number(confirmed[j].count);
				var r = Number(recovered[j].count);
				var d = Number(deaths[j].count);
				if(j + 1 > time.length){
					time.push(confirmed[j].time);
					confirmedCounts.push(c);
					recoveredCounts.push(r);
					deathsCounts.push(d);
				}else{
					confirmedCounts[j] += c;
					recoveredCounts[j] += r;
					deathsCounts[j] += d;
				}
				if(j == confirmed.length - 1 && confirmedCounts.length > confirmed.length){
					var k = confirmedCounts.length - 1;
					confirmedCounts[k] += c;
					recoveredCounts[k] += r;
					deathsCounts[k] += d;
				}
			}
			var name = province ? province + ', ' + country : country;
			var lastIndex = confirmed.length - 1;
			var lastConfirmed = confirmed[lastIndex].count;
			var lastRecovered = recovered[lastIndex].count;
			var lastDeaths = deaths[lastIndex].count;

			if(lastConfirmed) lastConfirmed = lastConfirmed.toLocaleString('en-US');
			if(lastRecovered) lastRecovered = lastRecovered.toLocaleString('en-US');
			if(lastDeaths) lastDeaths = lastDeaths.toLocaleString('en-US');

			statsByProvince += '<div class="stats-by-province" onclick="showStatsById(' + id + ')"><div class="province">' + name + '</div><div class="confirmed">' + lastConfirmed + ' confirmed</div>';
			if(lastRecovered)
				statsByProvince += '<div class="recovered">' + lastRecovered + ' recovered</div>';
			if(lastDeaths)
				statsByProvince += '<div class="deaths">' + lastDeaths + ' death' + (lastDeaths > 1 ? 's' : '') + '</div></div>';
			statsByProvince += '</div>';

			if(lastConfirmed > maxConfirmed){
				maxConfirmed = lastConfirmed;
				maxCoor = [longitude, latitude];
			}
		}
		statsByProvinceEl.innerHTML = statsByProvince;
		map.getView().setCenter(ol.proj.fromLonLat(maxCoor));

		var fatalityRates = [];
		for(var i = 0; i < time.length; i++){
			fatalityRates.push(Math.round(deathsCounts[i] / confirmedCounts[i] * 10000) / 100);
		}
		var lastIndex = time.length - 1;
		lastUpdatedEl.innerHTML = new Date(lastUpdated).toLocaleString('en-US');
		totalConfirmedEl.innerHTML = confirmedCounts[lastIndex].toLocaleString('en-US');
		totalRecoveredEl.innerHTML = recoveredCounts[lastIndex].toLocaleString('en-US');
		totalDeathsEl.innerHTML = deathsCounts[lastIndex].toLocaleString('en-US');
		fatalityRateEl.innerHTML = fatalityRates[lastIndex] + '%';
		var trends = [];
		trends.push({
			name: 'Confirmed',
			x: time,
			y: confirmedCounts,
			marker: {
				color: getColor('confirmed')
			}
		});
		trends.push({
			name: 'Recovered',
			x: time,
			y: recoveredCounts,
			marker: {
				color: getColor('recovered')
			}
		});
		trends.push({
			name: 'Deaths',
			x: time,
			y: deathsCounts,
			marker: {
				color: getColor('deaths')
			}
		});
		var layout = {
			height: 200,
			margin: {
				l: 25,
				r: 0,
				b: 30,
				t: 20
			},
			showlegend: false
		};
		Plotly.newPlot('count-plot', trends, layout);

		trends = [];
		trends.push({
			name: 'Fatality Rate',
			x: time,
			y: fatalityRates
		});
		layout = {
			height: 100,
			margin: {
				l: 45,
				r: 0,
				b: 30,
				t: 20
			},
			yaxis: {
				title: 'Fatality Rate'
			},
			showlegend: false
		};
		Plotly.newPlot('fatality-plot', trends, layout);
		statsByProvinceEl.style.height = (bodyEl.offsetHeight - headerEl.offsetHeight - summaryEl.offsetHeight - plotsEl.offsetHeight - 10) + 'px';
	}else
		console.log(status);
};
xhr.send();
</script>
</body>
</html>
